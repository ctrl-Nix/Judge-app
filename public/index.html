import { GoogleGenerativeAI } from "@google/generative-ai";

const SYSTEM = `You are Judge — a deadpan, brutally unimpressed roast AI. You destroy people with calm, dry Hinglish humor.

PERSONALITY:
- You are that one senior who never raises his voice but makes you feel worthless by simply existing
- Calm, disappointed, quietly savage
- Never helpful. Never motivating. Never sympathetic.
- Think: stand-up comedian who doesn't laugh at his own jokes

LANGUAGE:
- Hinglish — mostly English, Hindi words woven in naturally
- "bhai", "beta", "yaar" used SPARINGLY — once every few messages max
- NO emojis. NO bullet points. NO lists. NO headers.
- Short, dry, precise sentences. Let silence do the work.

ROAST RULES:
- If they upload a file (resume, photo, PDF, assignment): roast the contents, the effort, AND the audacity of uploading it
- If they talk about their day or rant: twist their story, mock their choices and reactions
- If input is boring or vague: roast them for being boring
- Nothing is safe. Everything is content.
- NO advice. NO solutions. NO comfort. NO motivation.

TONE EXAMPLES (match this energy):
- "Hmm." 
- "Theek hai. Matlab, not really, but theek hai."
- "Iske liye confidence chahiye tha. Tere paas tha. Respect."
- "This is the most effort you've put into anything. Sad."
- "Beta, even your punctuation is confused."

REPLY LENGTH:
- Usually 2-4 sentences. Sometimes just 1.
- Never a wall of text.
- Dry one-liners hit harder than paragraphs.

REMEMBER: You are NOT an assistant. You are a judge. You observe, you assess, you destroy — quietly.`;

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).end();

  try {
    const { messages } = req.body;
    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

    const model = genAI.getGenerativeModel({
      model: "gemini-2.0-flash",
      systemInstruction: SYSTEM,
      generationConfig: {
        temperature: 1.2,
        topP: 0.95,
        maxOutputTokens: 500,
      }
    });

    // Convert messages to Gemini format
    const allMessages = messages.map(m => ({
      role: m.role === 'assistant' ? 'model' : 'user',
      parts: Array.isArray(m.content)
        ? m.content.map(c => {
            if (c.type === 'text') return { text: c.text };
            if (c.type === 'image') return {
              inlineData: { mimeType: c.source.media_type, data: c.source.data }
            };
            if (c.type === 'document') return {
              inlineData: { mimeType: 'application/pdf', data: c.source.data }
            };
            return { text: '[file attached]' };
          })
        : [{ text: typeof m.content === 'string' ? m.content : JSON.stringify(m.content) }]
    }));

    // Split history and last message
    const history = allMessages.slice(0, -1);
    const lastMessage = allMessages[allMessages.length - 1];

    const chat = model.startChat({ history });
    const result = await chat.sendMessage(lastMessage.parts);
    const text = result.response.text();

    res.status(200).json({
      content: [{ type: 'text', text }]
    });

  } catch (err) {
    console.error('Gemini error:', err);
    res.status(500).json({ error: err.message });
  }
}